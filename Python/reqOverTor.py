import socks
import argparse
import urlparse
import httplib
import os

#If you have changed configuration settings while install the Tor
#You have to change TOR_SERVER and TOR_PORT consts. Otherwise these values are default.

TOR_SERVER = "127.0.0.1"
TOR_PORT = 9050

headers = { "Accept" : "*/*", }

def run():
    parser = argparse.ArgumentParser(description='Connection over TOR proxy')
    parser.add_argument('-c',action="store",dest="site",help ="Connection url like (www.anysite.com/filename.extension)")
    args = parser.parse_args()

    if args.site == None:
        parser.print_help()
        print("You must supply a site to connection")

    #The request will be work only HTTP proxy
    if not args.site.lower().startswith( "http://" ):
        args.site = "http://" + args.site

    socket = socks.socksocket()
    socket.set_proxy(socks.SOCKS5, TOR_SERVER, TOR_PORT)

    # the 'url' variable includes variety information like hostname, path which used in httplib
    url = urlparse.urlparse( args.site )

    #default port number is 80(HTTP), don't need to pass it
    connection = httplib.HTTPConnection( url.hostname )
    connection.request( "GET" , url.hostname , None , headers )
    data = connection.getresponse()
    data = data.read()

    if len(bytearray(data)) == 0:
        print("0 byte received. Something may be wrong!")
    else:
        print("Receievd {0} bytes from source.".format(len(data)))

    #get filename and extension as separate from connection site
    outputFile = os.path.basename(args.site)
    file = open(outputFile , "wb" )
    file.write(data)
    file.close()
    

if __name__ == '__main__':
    run()
